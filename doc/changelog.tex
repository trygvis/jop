\documentclass[a4paper,12pt]{scrartcl}
\usepackage{pslatex} % -- times instead of computer modern

\usepackage[colorlinks=true,linkcolor=black,citecolor=black]{hyperref}
\usepackage{booktabs}
\usepackage{graphicx}


\usepackage[latin1]{inputenc}

\newcommand{\code}[1]{{\textsf{#1}}}
\newcommand{\excelwidth}{10cm}


\begin{document}

\title{Change Log for JOP}
%\author{Martin Schoeberl\\ Vienna University of Technology, Austria\\ mschoebe@mail.tuwien.ac.at}
\maketitle \thispagestyle{empty}

\begin{abstract}

Major changes in the JOP project.

\end{abstract}



\section{Performance Tracker}

Table~\ref{tab:perf} shows the changing performance due to changes
in JOP.

\begin{table}
    \centering

    \begin{tabular}{rrrrrrl}
        \toprule
        Date & Version & Kfl & UdpIp & Lift & LCs & Comment \\
        \midrule
        ??? & 20050509 & 16582 & 6849 & &  & Austrochip \\
        13.6.2005 & & 16599 & 6838 & &  & with direct object pointers \\
        13.6.2005 & & 16384 & 6405 & &  & with handle indirection \\
        14.6.2005 & 20050614 & 16591 & 6838 & & 2711 & without
        handles again \\
        27.6.2005 & 20050620 & 16367 & 6405 & & 2716 & handles again \\
        26.7.2005 & 20050620 & 16367 & 6405 & & 2716 & \\
        31.7.2005 & 20050728 & 16384 & 6405 & & 2714 & \\
        11.8.2005 & 20050728 & 16367 & 6405 & & 2714 & \\
        16.8.2005 & 20050816 & 16253 & 6258 & & 2726 & new .jop format, Null pointer check \\
        & & & & & &in xaload/xastore is moved! \\
        23.11.2005 & 20050827 & 16237 & 6262 & & 2927 & cycmin (w. WB test slaves) \\
        23.11.2005 & 20050827 & 16270 & 6272 & & 2827 & new memory interface (in cycwrk) \\
        & & & & & & avoid 'register packing' -- Quartus crash \\
        1.1.2006 & 20051220 & 16270 & 6262 & & 2680 & new IO interface \\
        11.1.2006 & 20060111 & 16270 & 6262 & & 2691 & HW for exception (stack
        overflow)\\
        12.1.2006 & 20060111 & 16270 & 6262 & & 2703 & with add. SW
        exceptions (div. by zero)\\
        12.1.2006 & 20060112 & 16591 & 6365 & & 2700 & add ar, iinc
        is now 8 cycles\\
        22.1.2006 & 20060122 & 16591 & 6365 & & 2717 & additional field instructions \\
        23.1.2006 & 20060123 & 16591 & 6522 & & 2722 & offset in field instructions \\
        15.6.2006 & 20060615 & 16633 & 6537 & & 2722 & less cycles
        on cache load\\
        16.9.2006 & 20060615 & 17075 & 6692 & & 2722 & substitute
        IINC\\
        8.10.2006 & 20060615 & 17093 & 6809 & & 2776 & optimized
        with ProGuard\\
        4.11.2006 & 20061104 & 17111 & 6775 & & 2778 & changed
        object layout\\
        4.11.2006 & 20061104 & 17138 & 6889 & & 2778 & changed
        object layout + ProGuard\\
        30.12.2006 & 20061230 & 17111 & 6775 & & 2687 & 2K ROM (Q 6.1)\\
        11.04.2007 & 20070317 & 17120 & 6781 & 13574 & 2691 & no real
        change (Q 7.0)\\
        14.04.2007 & 20070414 & 18347 & 8520 & 16425 & 2906 & array HW \\
        31.08.2007 & 20070831 & 18347 & 8371 & 16425 & 2930 & use more stack \\
        04.12.2007 & 20071203 & 18347 & 8308 & 16425 & 3091 & added interrupt controller \\
        19.02.2008 & 20080219 & 18357 & 8511 & 18778 & 3092 & getfield/putfield HW support \\
        20.02.2008 & 20080220 & 18347 & 8511 & 18767 & 3136 & IO/memory MUX after mem\_sc \\
        22.08.2008 & 20080522 & 18275 & 8474 & 18671 & 3579 & memory write one cycle longer \\
        10.12.2008 & 20081012 & 19907 & 8837 & 18930 & 3486 & static access with index as address \\
        05.03.2009 & 20090305 & 19907 & 8837 & 18930 & 3496 & long operations in microcode \\
        05.09.2009 & 20090905 & 20004 & 8856 & 18962 & 3502 & use jmp microcode (usb100 LCs) \\
        17.11.2009 & 20091117 & 20004 & 9031 & 20454 & 3615! & MMU uses opd for get/putfield (usb100 LCs) \\
        23.11.2009 & 20091123 & 20699 & 9168 & 20569 & 3666! & MMU support for get/putstatic (usb100 LCs) \\
        28.11.2009 & 20091128 & 20699 & 9256 & 21005 & 3748! & Single word object cache (usb100 LCs) \\
        30.11.2009 & 20091128 & 24058 & 10144 & 24308 & 3748! & with JOPtimizer \\
        28.10.2010? & 20101028 & 20726 & 9209 & 20647 & 3854! & without O\$ (usb100 LCs) (why 200 LCs bigger?) \\
        07.01.2011 & 20110107 & 20726 & 9356 & 23076 & 4470 & with O\$ 16-way/8 fields (usb100 LCs) \\
\bottomrule
    \end{tabular}
    \caption{JOP performance with 100MHz, 4KB/16 cache, cycmin}
    \label{tab:perf}


\end{table}
Nokia 6300 with Jazelle is the real target ;-)

\begin{verbatim}
    ARM9 237 MHz
    iaload_3 iadd 81840000 1/s 3 cycles
    iinc 83886000 1/s 3 cycles
    ldc 11066000 1/s 22 cycles
    if_icmplt 28149000 1/s 8 cycles
    if_icmplt not taken 47662000 1/s 5 cycles
    getfield 45221000 1/s 5 cycles
    getstatic 32704000 1/s 7 cycles
    iaload 35544000 1/s 7 cycles
    invoke 1836000 1/s 129 cycles
    invokestatic 1967000 1/s 120 cycles
    invokeinterface 1855000 1/s 127 cycles
    Sieve 26068 1/s
    Kfl 43229 1/s
    UDP/IP 11595 1/s
\end{verbatim}

\section{Changelog}

\subsection{Hardware}


\paragraph{20051201}

IO devices are memory mapped (SimpCon) -- no more stioa, stiod,
ldiod.


\paragraph{20060111}

Start to generate HW exceptions similar to the timer interrupt.
Exception logic is in \code{cnt.vhd} (should perhaps get renamed).
First exception is generated by a stack overflow (SP=0xff).

\paragraph{20060112}

Add a new register (\code{ar}) to address the local memory:

\begin{itemize}
    \item New microcode instructions: star, ldmi, stmi
    \item Use it instead of vp on various bytecodes
    \item reduce vp to 7 bits (only the upper half of the local
        memory)
    \item ld and st instruction changed coding, different address
        mux coding -- document in JOP instruction set
    \item iinc is now 8 instead of 11 cycles
\end{itemize}

\paragraph{20060615}

Enhanced memory/cache interface: Avoid one state, load one word less.

\paragraph{20061230}

Microcode ROM extended to 2K (with arom.vhd again), long array
bytecodes enabled again, additional stack manipulation bytecodes.
Class structure extended by pointer to super class, checkcast,
instanceof.

\paragraph{20070317}

Restructure of JOP components: Additional \code{jopcpu} contains
\code{core}, \code{extension}, and \code{mem\_sc}. Simple AMBA slave
interface for SimpCon paper (FPL 2007).

\paragraph{20070414} Array load and store in hardware.

Original cycmin: 2691 LCs, 88.4 MHz (extension: 62, mem\_sc: 113).
Original iaload timing: 32 + 3r = 35 and iastore timing: 35 + 2r + w
= 38.

Implement xaload and xastore in hardware. New timings: iaload: 7 + 3r
= 10, iastore: 9 + 2r + w = 12.

cycmin w array HW: 2906 LCs, 93 MHz (extension: 70, mem\_sc: 304).

\paragraph{20070831}

Change stack pointer handling: no wrapping, exception generation at
maxstack-8, use constants for stack size and start, changed start to
64. With 512 stack words LC is 2948 (instead of 2906).

\paragraph{20070909} sc\_ram16.vhd violated SimpCon rule to hold data in the
register till new data arrives (used data input register to store
first 16-bit value). Results in an error in the array bounds check.
Added another register in sc\_ram16.vhd -- leads to on input MUX for
RAM data register. Therefore, relax tsu constraint for the SRAM.

\paragraph{20071012} Port to digilent nexys2 board: Added top-level
jop\_nexys2.vhd, nexys2 project in xilinx folder. Quick hack uses
only 4~MB of the 16~MB PSDRAM with a lot of wait states.

\paragraph{20071121} more space in stack.vhd for the stack
trace. Use 33 bit for the comparison (compare bug for diff $>$ 2**31
in stack.vhd corrected).

\paragraph{20071122} Christof checked in the work on JOP CMP
(jvm.asm, jop\_types.vhd, cmpsync.vhd, sc\_sys.vhd,
jopmul.vhd).

\paragraph{20071202} Additional signal from \code{bcfetch} to
\code{sc\_sys} (interrupt acknowledgement). Move most interrupt
logic to \code{sc\_sys}. Interrupt ack from \code{jfetch},
interrupt disable on handling.

\paragraph{20071203} prioritized interrupt processing, affects
RtThread scheduling.

\paragraph{20071222} Correction of data MUX bug in \code{extension.vhd} for array read
access -- was set to IO after an IO access, array read did not set
it.

\paragraph{20080218} WP: Faster multiplier: 15\% larger, but twice as
fast; \code{imul} now takes 19 cycles.

\paragraph{20080219} WP: getfield and putfield in hardware
(\code{mem\_sc}).

\paragraph{20080220} MS: Moved IO/memory muxing after the memory controller into
\code{jopcpu} to keep the hardware objects working. Hurts fmax a
little bit (92~MHz).

\paragraph{20080221} CP: All scios changed to select the accurate rdy\_cnt for a write
on an IO.

\paragraph{20080222} CP: Added atomic to the SimpCon interface.

\paragraph{20080222} CP: Checked in all different kinds of Arbiters working with the
\code{cyccmp} and the \code{altde2cmp} projects.

\paragraph{20080303} MS: Added scratchpad RAM to \code{jopcpu.vhd}.

\paragraph{20080304} MS: correct MUX selection in \code{jopcpu.vhd}.

\paragraph{20080311} MS: Interrupt global enable also in \code{bcfetch} (bug
fix).

\paragraph{20080430} WP: Added microcode for non-blocking copying.
\emph{MS: and what VHDL fiels have been changed?}

\paragraph{20080522} MS: \code{nwe} on positive edge, additional
write wait state in \code{sc\_sram32\_flash.vhd}. \code{cycbg} at
60~MHz, modem baud rate now 115 kbit.

\paragraph{20080625} WP: Fixed method cache/program counter bug; changes in
\code{bcfetch.vhd}, \code{core.vhd} and \code{stack.vhd}.

\paragraph{20080721} MS: \code{nwe} in first two cycles, data out
enable till the last cycle in \code{sc\_sram32\_flash.vhd}. TODO: use
configurable wait states (again), adapt other two SRAM interfaces.

\paragraph{20080821} CP: Fixed bug in (\code{sc\_arbiter\_fair} and
\code{sc\_arbiter\_tdma}) for pipelined memory access to a 16-bit
SRAM.

\paragraph{20080822} CP: Fixed the sram interfaces (\code{sc\_sram32\_flash.vhd},
\code{sc\_sram32}, \code{sc\_sram16}) to be configurable depending on
the wait sates.

\paragraph{20081010} MS: correct array access for fast on-chip memory
(\code{mem\sc.vhd}).

\paragraph{20081112} MS: error correction in \code{sc\_sram16.vhd}: data enable also in last
state of write, removed idle state between the two writes. Same error
is still in \code{sc\_sram8.vhd} -- could be the issue on the Actel
board!

\paragraph{20090118} MS: change NAND interface to read the ready
signal without reading data (\code{sc\_sram32\_flash.vhd}). 10 cycles
for a ROM access (various top level).

\paragraph{20090904} MS: microcode redesign, new unconditional jmp
instruction, branch and jump offset in the instruction (no offtbl.vhd
anymore).

\paragraph{20091117} MS: put/getfield in mmu (\code{stpf}, \code{stgf})
uses bytecode operand directly for the index.

\paragraph{20091123} MS: MMU support for get/putstatic (\code{stps}, \code{stgs})
uses bytecode operand directly for the index.

\paragraph{20091128} MS: Single word object cache for put/getfield.

\subsection{Software}

\paragraph{20050620}

Added GC info field in class structure: ClassInfo.java (JOPizer),
JVM.java (f\_new). Use handle, changed multianewarray to work with
handles.

\paragraph{20050625}

Working stop-the-world, two space GC committed to CVS.

\paragraph{20051217}

Prototype of periodic scheduled real-time GC for the ISORC paper.

\paragraph{20060120}

Add individual field instructions for long and reference fields
(\emph{special} bytecodes).

\paragraph{20060123}

Long instructions in JVM.java added (Peter and Christof jvmhw work).
Replace CP index in field instructions by the field offset.

\paragraph{20060819}

System.arraycopy: Hello World is 11 KB code, 19 KB all. Changes in:
\begin{itemize}
    \item GC: use type info of array + types for ref. and plain
        objects in handle
    \item 20 KB with arraycopy() and additional Exceptions
    \item 21 KB with Java 1.5 corrections (16.9.2006)
\end{itemize}

\paragraph{20060916}

Substitute IINC by ILOAD, PUSH const, IADD, and ISTORE in JOPizer to
avoid Java 1.5 compiler issues and improve the performance a little
bit. Java 1.5 compiler can now be used (with -target 1.4).

\paragraph{20061008}

Optimize with \url{http://sourceforge.net/projects/proguard/}

\paragraph{20061026}

Merged Nelsons JDK port into the source tree. Moved \code{jdk} to
three different directories: \code{jdk\_base}, \code{jdk11}, and
\code{jdk14}. TODO: Check size of Hello World.

\paragraph{20061104}

Move mtab pointer and array size to the handle. Small optimization in
array load and store (one cycle). invokevirtual, invokeinterface and
arraylength should be faster.

\paragraph{20070111}

Check new TCP/IP stack (TU Graz). Application size:
\begin{itemize}
    \item Hello World 33 KB (!)
    \item ejip.Main 47 KB (old stack)
    \item ejip.Main 49 KB (some changes)
\end{itemize}

20060818: Hello World 19 KB

%Questions:
%
%Warum zusaetzlich Payload und nicht Packet weiterverwenden?
%
%Das Zusammenstellen eines IP Paketes ist sehr aufwendig (z.B.:
%prepareIPPacket())

\paragraph{20070411}

New version of JavaBenchEmbedded (1.1) with an additional \emph{Lift}
benchmark.

\paragraph{20070528}

putfield and putstatic for references invoke JVM.java (for GC
write-barriers).

\paragraph{20070803}

Add pointer to static primitive fields into the class structure (for
Hardware objects).

\paragraph{20070911} Changes in ejip for TCP addition and some
cleanup in packet manipulation. TCP connection works for a very simple
Telnet server.

\paragraph{20071002} Add changes for the debugger (in JOPizer, ClassInfo, MethodInfo).
Correct wrong Makefile (Wolfgang) and add debugger changes.

Removed build.bat/xml and jcc.jar in tools directory.

Added debugger code in tools directory (com.jopdesign.debug,
com.sun), added debug test kernel in target/src/test.

\paragraph{20071006} Changed JOPizer to generate a correct static
class initializer order.

\paragraph{20071008} Correction of clinit error: Long methods have
the length set to 0, but got invoked instead of interpreted (len<256
corrected to len<256 \&\& len!=0).

\paragraph{20071115} Null pointer exception in ClinitOrder
(from test/testrt/Periodic) corrected.

\paragraph{20071121} stack tracing enabled, better trace output.

\paragraph{20080113} Moving IO-device models from JopSim into their
own classes. Can also be loaded dynamically (use the \code{ioclass}
property with the class name, e.g., \code{-Dioclass="IOSimWD"}).

\paragraph{20080115} GC bug fix by Paulo. GC did not use the
constants for stack start and size for the root scanning in
stop-the-world mode.

\paragraph{20080205}

Added invokesuper bytecode: the case of invoking the method of a
super-class was not handled correctly by invokespecial. JOPizer
replaces invokespecial with invokesuper where appropriate.

\paragraph{20080221} WP: JOPizer: insert monitorenter and monitorexit for
synchronized (non-static) methods.

\paragraph{20080623} WP: Implemented athrow as specified by the JVM specification. Changed
system code in a few places such that exceptions are throw instead of
aborting immediately.

\paragraph{20080624} WP: JOPizer: interface tables are now generated correctly

\paragraph{20080626} MS: Back to original scheduler, OEBB BG version
2.16

\paragraph{20080703} WP: Fixed null pointer handling of invokexxx
instructions (\code{jvm\_call.inc}).

\paragraph{20080713} MS: Native versions of getfield, putfield,
arraylength, iaload, and iastore. TODO: use it in putfield\_ref, use
hardware for long versions of get/putfield and array access to use
the GC copy redirection!

\paragraph{20080723} MS: Scheduler change for CMP scheduling.
Scheduler is now an object -- a \code{Runnable} that is registered as
an interrupt handler for the time interrupt. Each CMP core has it's
own scheduler registered on \code{missionStart()}.

\paragraph{20080915} CP: Added WCET analysis for CMP in WCET tool of
Rasmus and Martin. Description see JTRES 2008 paper.

\paragraph{20080916} MS: changed to -source 1.5, added and changed
the BCEL 5.1 sources, four needed classes in jdk11 (Void, Double,
Comparable, Number).

\paragraph{20081016} MS: changes in the JOPizer tool flow to make a
more general use of \code{ClassInfo} and \code{MethodInfo}.
Preprocessing (iinc, synchronized) for WCA. WCA delivers now (again)
exact cycles for \code{wcet.Loop} with Java 1.5/1.6 ;-)

\paragraph{20081210} MS: Static field access uses index as address.
Changes in \code{JOPizer}, \code{jvm.asm}, \code{jvm\_long.asm},
\code{Startup.java}, \code{JopSim.java}, and in WCET timing.

\paragraph{20090305} WP: Support for long operations (ladd, lsub,
lneg, land, lor, lxor, lshr, lushr, lshl, i2l) in microcode. Changes
in \code{jvm\_long.asm} and in WCET timing; minor cleanups in
JVM.java, but kept Java implementations for long bytecodes.

\paragraph{20090626} WP: Fixed invokesuper special bytecode. The
invoked method depends on which implementation of a method is
executed, not the class of \code{this}.

\paragraph{20090727} MS: switch to BCEL 5.2 for enum support. Two
bugs in BCEL 5.2 fixed.

\subsection{Documentation}

\paragraph{20080108} corrected timing for \code{xastore}. It's $10 +
2r + w$.

\section{Ant}

\begin{itemize}
    \item Download ant (about 30 MB unzipped)
    \item add ant/bin to your path
\end{itemize}

\section{Possible Enhancements}

\subsection{VHDL}

\begin{itemize}
    \item tristate handling inside the memory component
    \item try to minimize the top-level -- more connections into the
    core
    \item rethink SC address decoding: more flexible for IO devices,
    additional SC components such as NoC memory
    \item check \code{scio\_rd <= sc\_rd;} in \code{extension.vhd}.
    Shouldn't it by \code{scio\_rd <= sc\_rd and not ain(31);}?
\end{itemize}

check \url{http://lipforge.ens-lyon.fr/www/divgen/} for division (a
divisor generator).

\section{Issues, Questions}

\begin{itemize}
    \item Flag \emph{opd} has to be immediately before usage by ld\_opd.
    Why? (see instruction getfield).
    \item Do we really need the full class info for interfaces? Why?
\end{itemize}

\section{JDK based on phoneME change}

\subsection{System dependent classes}

\begin{itemize}
  \item System
  \item Object
  \item String ??
  \item special IO classes (JOP-streams)
  \item Class (we don't have one)
\end{itemize}

\subsection{Take care}

\begin{itemize}
  \item Our current StringBuffer contains a StringBuffer append
      (since JDK 1.4)
  \item How to avoid the big time zone thing?
  \item How to avoid all the encoding stuff?
  \item find all native methods -- check on Jopizer
  \item Wouldn't a JDK 1.4 -- 1.6 Classpath or Sun's JDK be a
      better base?
\end{itemize}

\subsection{Ideas}

\begin{itemize}
  \item What about moving com.jopdesign.sys stuff into java.lang?
  \item Can we get rid of some public methods/classes from the
      c.j.sys package?
\end{itemize}



\section{Optimization}

see \url{http://www.arm.com/pdfs/JazelleWhitePaper.pdf}

Test with \url{http://www.cs.purdue.edu/s3/projects/bloat/}:

\begin{verbatim}
    -classpath /usr/cpu/jop/java/target/dist/classes -verbose
    -stack-alloc jbe.kfl.Mast jbe.kfl.Msg jbe.kfl.Timer jbe.kfl.JopSys
    jbe.kfl.Triac /usr/cpu/jop/java/target/dist/new_classes

   with the main class: EDU.purdue.cs.bloat.optimize.Main
\end{verbatim}

\subsection{JMM}

check \url{http://g.oswego.edu/dl/jmm/cookbook.html}

\section{Thesis Errata}

In the thesis you state jop can handle "16 different immediate
values ..." (pg 68). However ldi microcode can address 32 constants.

There are 32 JVM local variables and 32 constants. In the Thesis the
numbers are 16 and 16.

Stack figure.

\section{CLDC TODO}

\begin{itemize}
    \item Object.clone()
    \item add a Duke image from \url{https://duke.dev.java.net/}
    \item
\end{itemize}



\end{document}
